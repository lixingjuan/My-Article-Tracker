<html><body><h1 id="请求类型">请求类型</h1>
<p>在 web 开发中，与<strong>跨域资源共享</strong>相关的请求分为两类：简单请求和复杂请求。</p>
<p>根据<strong>请求类型、头部和使用内容类型</strong>，决定在发送请求之前是否要先向服务器发送一个<strong>预检请求（preflight request）</strong></p>
<h2 id="简单请求">简单请求</h2>
<p>以下 5 个条件，需要同时满足则是简单请求：</p>
<ol>
<li>请求方法：get、post、head；</li>
<li>除了被用户代理自动设置的头部字段，<strong>人为设置的请求头字段</strong>只能有以下四个：<ol>
<li>accept</li>
<li>accept-language</li>
<li>content-language</li>
<li>content-type</li>
</ol>
</li>
<li><strong>content-type</strong>，首部所指定的媒体类型的值仅限于下列三者之一：<ol>
<li><code>text/plain</code></li>
<li><code>multiple/form-data</code></li>
<li><code>application/x-www-form-urlencoded</code></li>
</ol>
</li>
<li>如果请求是使用 XMLHttpRequest 对象发出的，没有调用 <code>xhr.upload.addEventListener()</code>，以监听该上传请求；</li>
<li>没有使用 <code>ReadableStream</code> 对象</li>
</ol>
<h2 id="复杂请求">复杂请求</h2>
<p>除简单请求以外的请求均为复杂请求，复杂请求会自动进行预检请求。对于这类请求，浏览器会先发出一个预检请求，验证主请求是否安全可接受。预检请求使用 OPTIONS 方法，并包含以下两个头部字段：</p>
<p><code>Access-Control-Request-Methods</code>: 通知服务器实际讲求将包含的方法
<code>Access-Control-Request-Headers</code>: 列出实际请求将包含的自定义头字段</p>
<p>服务器必须响应这个请求，并明确允许请求的方法、头字段、源，分别通过
Access-Control-Allow-Methods、Access-Control-Allow-Headers、Access-Control-Allow-origin 三个字段给出。如果预检请求成功，则浏览器发布真实的主请求。</p>
<h2 id="为什么复杂请求需要预检请求？">为什么复杂请求需要预检请求？</h2>
<p>预检请求是一种安全机制，保证服务器不受恶意请求的影响。通过预检请求，服务器可以在实际处理前检查跨源请求，以确保请求是经过授权的。尤其是在进行对服务器数据更大影响的请求类型，如 PUT、DELETE、或含有自定义头字段的请求尤其重要。</p>
<h2 id="预检请求有效时间？">预检请求有效时间？</h2>
<p>预检请求的响应可以被缓存，缓存的有效期是由服务器通过 响应头字段 <code>Access-Control-Max-age</code> 字段设置的。这个响应头表示 preflight 响应的有效时间（单位是秒），在这个有效时间内，相同的跨源请求不需要再次进行 preflight 检查。</p>
<p>注意点：
<strong>缓存作用域</strong>：preflight 的缓存仅适用于相同 URL、请求方法和请求头。任何变化都可能需要新的 Preflight 检查；
<strong>浏览器差异</strong>：不同浏览器对 Preflight 缓存的实现会有差异；
<strong>安全性</strong>：服务器应谨慎设置 <code>Access-Control-Max-age</code>，避免过长时间的缓存导致的安全性问题；</p>
</body></html>